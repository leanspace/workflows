name: "SonarCloud analysis, build and Nexus deployment"
on: 
  workflow_call:
    secrets:
      NEXUS_PASSWORD:
        required: true
      NEXUS_USERNAME:
        required: true
      NEXUS_URL:
        required: true
      LEANSPACE_BOT_TOKEN:
        required: true
      SONAR_TOKEN:
        required: true
jobs:
  build-deploy:
    runs-on: ubuntu-latest
    env:
        AWS_REGION: eu-central-1
        NEXUS_PASSWORD: ${{ secrets.NEXUS_PASSWORD }}
        NEXUS_USERNAME: ${{ secrets.NEXUS_USERNAME }}
        NEXUS_URL: ${{ secrets.NEXUS_URL }}
    steps:
    - name: Checkout main repo
      uses: actions/checkout@v2
      with:
        fetch-depth: 0 
    - name: Checkout config-files repo
      uses: actions/checkout@v2
      with:
        repository: leanspace/global-config-files
        path: './config-files'
        token: ${{ secrets.LEANSPACE_BOT_TOKEN }}
    - name: Set credentials on config file
      run: |
        sed -i "s/NEXUS_USERNAME/$NEXUS_USERNAME/g" config-files/maven/nexus-config.xml
        sed -i "s/NEXUS_PASSWORD/$NEXUS_PASSWORD/g" config-files/maven/nexus-config.xml
        sed -i "s|NEXUS_URL|$NEXUS_URL|g" config-files/maven/nexus-config.xml
    - name: Set up JDK 11
      uses: actions/setup-java@v1
      with:
        java-version: 11
    - name: Cache SonarCloud packages
      uses: actions/cache@v1
      with:
        path: ~/.sonar/cache
        key: ${{ runner.os }}-sonar
        restore-keys: ${{ runner.os }}-sonar
    - name: Cache Maven packages
      uses: actions/cache@v1
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    - name: Build and analyze
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: mvn -B verify org.sonarsource.scanner.maven:sonar-maven-plugin:sonar -gs config-files/maven/nexus-config.xml -Dsonar.projectKey=leanspace_${{ github.event.repository.name }}
    - name: Set env
      run: echo "ARTIFACT_IDENTIFIER=0.1.${GITHUB_RUN_NUMBER}_${GITHUB_SHA:0:6}" >> $GITHUB_ENV
    - name: Deploy to nexus
      if: github.ref_name == 'master'
      run: mvn deploy -DskipTests -gs config-files/maven/nexus-config.xml -Drevision=${ARTIFACT_IDENTIFIER}